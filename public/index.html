<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat App</title>
  <style>
    .chat {
      display: flex;
      flex-direction: column;
      height: 80vh;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .my-message {
      align-self: flex-end;
      margin-left: auto;
      text-align: right;
    }

    .other-message {
      align-self: flex-start;
      margin-right: auto;
      text-align: left;
    }

    .number-input {
      width: 80px;
      padding: 5px;
      font-size: 16px;
    }

    .form {
      display: flex;
    }

    .input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
    }

    .box {
      display: flex;
      align-items: center;
      margin-top: 20px;
    }

    .submit {
      padding: 10px;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
    }

    input[type="color"] {
      width: 32px;
      height: 32px;
      padding: 0;
      display: inline-block;
      margin-right: 18px;
      border: 1px solid rgb(0, 0, 0);
      border-radius: 50%;
    }

    input[type="color"]::-webkit-color-swatch,
    input[type="color"]::-webkit-color-swatch-wrapper {
      border: none;
      padding: 0;
      border-radius: 50%;
    }

    input[type="text"] {
      border: 1px solid rgb(0, 0, 0);
      padding: 5px;
    }

    #eraserToggle {
      margin-left: 10px;
    }

    .drawing-tools {
      display: flex;
      align-items: center;
      margin-top: 10px;
      gap: 15px;
      /* è¦ç´ é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
      flex-wrap: wrap;
      /* è¦ç´ ãŒåã¾ã‚‰ãªã„å ´åˆã«æŠ˜ã‚Šè¿”ã™ */
      justify-content: center;
      /* ãƒ„ãƒ¼ãƒ«ã‚’ä¸­å¤®å¯„ã› */
    }

    .canvases-container {
      display: flex;
      gap: 20px;
      /* ã‚­ãƒ£ãƒ³ãƒã‚¹é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
      margin: 20px auto;
      /* ä¸Šä¸‹ã®ä½™ç™½ã¨å·¦å³ä¸­å¤®å¯„ã› */
      justify-content: center;
      /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä¸­å¤®å¯„ã› */
      align-items: flex-start;
      /* ä¸Šç«¯ã‚’æƒãˆã‚‹ */
    }

    .canvases-container canvas {
      display: block;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    #receivedCanvas {
      border: solid 1px red;
      /* å—ä¿¡ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã®æ ç·š */
    }

    #canvas {
      border: solid 1px black;
      /* æç”»ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã®æ ç·š */
    }
  </style>
</head>

<body>
  <div class="chat">
    <ul class="messages"></ul>
    <form class="form" id="chatForm">
      <input class="input" id="chatInput" autocomplete="off" />
      <button class="submit" id="chatSubmitButton">Send</button>
    </form>
  </div>

  <div style=" margin-top: 20px;">
    <label>
      ãƒ©ã‚¦ãƒ³ãƒ‰æ•°:
      <input type="number" id="roundSelect" class="number-input" min="1" max="10" step="1" value="3">
    </label>
    <label style="margin-left: 20px;">
      ã‚¿ãƒ¼ãƒ³æ•°:
      <input type="number" id="turnSelect" class="number-input" min="1" max="5" step="1" value="2">
    </label>
    <button id="startButton" style="margin-left: 20px;">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
  </div>

  <div id="gameStatus" style="font-size: 20px; font-weight: bold; margin: 10px 0;">
    <span id="firstChar" style="display: none;">æœ€åˆã®æ–‡å­—ã¯ </span>
    å…¥å®¤äººæ•°: <span id="playerCount">0</span>äºº
    <br />
    <span id="turnOrderDisplay" style="display: none;">ã‚¿ãƒ¼ãƒ³é †: </span>
  </div>

  <!-- ãµãŸã¤ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
  <div class="canvases-container">
    <canvas id="receivedCanvas" width="600" height="600"></canvas>
    <canvas id="canvas" width="600" height="600"></canvas>
  </div>

  <div class="drawing-tools">
    <!-- ç·šã®å¤ªã• -->
    <label>
      ç·šã®å¤ªã•:
      <input type="range" id="lineWidthSlider" min="1" max="20" value="5">
    </label>
    <!-- ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ -->
    <input type="color" id="colorPicker" value="#000000">
    <!-- æ¶ˆã—ã‚´ãƒ  -->
    <button id="eraserToggle">æ¶ˆã—ã‚´ãƒ  OFF</button>

    <!-- sendPictureãƒœã‚¿ãƒ³è¿½åŠ  -->
    <button id="sendPictureButton">Send Picture</button>

  </div>


  <!-- <canvas id="canvas" width="600" height="600" style="border: solid 1px black; display: none;"></canvas> -->

  <script>
    function main() {
      const myId = prompt("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")?.trim() || self.crypto.randomUUID().substr(0, 8);
      const host = location.origin.replace(/^http/, 'ws')
      const ws = new WebSocket(host + '/ws')

      let players = new Set();

      //ã‚²ãƒ¼ãƒ é–‹å§‹çŠ¶æ…‹ã‚’ç®¡ç†
      let gameStarted = false;
      //å›ç­”ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
      let answers = [];
      //æã‹ã‚ŒãŸç”»åƒã‚’ä¿å­˜ã™ã‚‹é…åˆ—
      let drawnImages = [];
      //ä¸€æ™‚çš„ã«æã‹ã‚ŒãŸç”»åƒã‚’ä¿æŒã™ã‚‹
      let currentDrawingData = null;


      const startButton = document.getElementById('startButton');
      const chatArea = document.querySelector('.chat');

      //ãƒãƒ£ãƒƒãƒˆå…¥åŠ›æ¬„ã¨ã€sendãƒœã‚¿ãƒ³ã€ç”»åƒsendãƒœã‚¿ãƒ³
      const chatInput = document.getElementById('chatInput'); // chatInputã®IDã‚’è¿½åŠ 
      const chatSubmitButton = document.getElementById('chatSubmitButton'); // chatSubmitButtonã®IDã‚’è¿½åŠ 
      const sendPictureButton = document.getElementById('sendPictureButton'); // æ–°ã—ã„ãƒœã‚¿ãƒ³ã‚’å–å¾—
      const drawingToolsContainer = document.querySelector('.drawing-tools');

      //æç”»ãƒ¢ãƒ¼ãƒ‰ã‹ã€å›ç­”å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã‹
      let isDrawingTurn = false; //çµµã‚’æãã‚¿ãƒ¼ãƒ³ã‹ã©ã†ã‹
      let isAnsweringTurn = false; //å›ç­”å…¥åŠ›ã‚¿ãƒ¼ãƒ³ã‹ã©ã†ã‹

      // å…¥å®¤äººæ•°è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
      function updatePlayerCountDisplay() {
        const playerCountElement = document.getElementById('playerCount');
        if (playerCountElement) {
          playerCountElement.textContent = players.size;
        }
      }

      // ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
      startButton.onclick = () => {
        const round = document.getElementById('roundSelect').value;
        const turn = document.getElementById('turnSelect').value;
        const playerCount = players.size;

        const confirmed = confirm(
          `å…¥å®¤äººæ•°: ${playerCount}äºº\nãƒ©ã‚¦ãƒ³ãƒ‰æ•°: ${round}ãƒ©ã‚¦ãƒ³ãƒ‰\nã‚¿ãƒ¼ãƒ³æ•°: ${turn}ã‚¿ãƒ¼ãƒ³\n\nã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ`
        );

        if (confirmed) {
          ws.send(JSON.stringify({ type: 'start' }));
          gameStarted = true;
          setDrawingTurnUI();

        }
      };


      const receivedCanvas = document.getElementById('receivedCanvas');
      const receivedCtx = receivedCanvas.getContext('2d');
      const canvas = document.getElementById('canvas')
      const ctx = canvas.getContext('2d')

      const colorPicker = document.getElementById('colorPicker');
      const lineWidthSlider = document.getElementById('lineWidthSlider');
      const eraserToggle = document.getElementById('eraserToggle');

      ctx.strokeStyle = colorPicker.value;
      ctx.lineWidth = lineWidthSlider.value;

      colorPicker.addEventListener('input', () => {
        if (!eraserMode) {
          ctx.strokeStyle = colorPicker.value;
        }
      });
      lineWidthSlider.addEventListener('input', () => {
        ctx.lineWidth = lineWidthSlider.value;
      });


      let drawing = false
      let eraserMode = false;

      eraserToggle.addEventListener('click', () => {
        eraserMode = !eraserMode;
        eraserToggle.textContent = eraserMode ? "æ¶ˆã—ã‚´ãƒ  ON" : "æ¶ˆã—ã‚´ãƒ  OFF";
        if (eraserMode) {
          ctx.strokeStyle = "#ffffff";//â†å®Ÿéš›ã«æ¶ˆã—ã¦ã„ãªã„ç™½ã§ä¸Šå¡—ã‚Šã—ã¦ã„ã‚‹
        } else {
          ctx.strokeStyle = colorPicker.value;
        }
      });

      canvas.addEventListener('mousedown', (e) => {
        sendDrawingEvent(e.offsetX, e.offsetY, 'mousedown')
      })
      function mousedown() {
        drawing = true
        ctx.beginPath()
      }

      canvas.addEventListener('mousemove', (e) => {
        if (drawing) {
          sendDrawingEvent(e.offsetX, e.offsetY, 'mousemove')
        }
      })
      function mousemove(x, y) {
        if (drawing) {
          draw(x, y, true)
        }
      }

      canvas.addEventListener('mouseup', (e) => {
        sendDrawingEvent(e.offsetX, e.offsetY, 'mouseup')
      })
      function mouseup() {
        drawing = false
        ctx.beginPath()
      }

      canvas.addEventListener('mouseout', (e) => {
        sendDrawingEvent(e.offsetX, e.offsetY, 'mouseout')
      })
      function mouseout() {
        drawing = false
      }

      function draw(x, y, dragging) {
        if (dragging) {
          ctx.lineTo(x, y)
          ctx.stroke()
        } else {
          ctx.moveTo(x, y)
        }
      }

      function enableDrawingTools() {
        canvas.style.pointerEvents = 'auto'; // æç”»å¯èƒ½ã«
        colorPicker.disabled = false;
        lineWidthSlider.disabled = false;
        eraserToggle.disabled = false; // æ¶ˆã—ã‚´ãƒ ã‚‚æœ‰åŠ¹ã«
        drawingToolsContainer.style.display = 'flex'; // æç”»ãƒ„ãƒ¼ãƒ«å…¨ä½“ã‚’è¡¨ç¤º
      }

      function disableDrawingTools() {
        canvas.style.pointerEvents = 'none'; // æç”»ã§ããªã„ã‚ˆã†ã«
        colorPicker.disabled = true;
        lineWidthSlider.disabled = true;
        eraserToggle.disabled = true; // æ¶ˆã—ã‚´ãƒ ã‚‚ç„¡åŠ¹ã«
        drawing = false; // æç”»ä¸­ãƒ•ãƒ©ã‚°ã‚’ã‚ªãƒ•ã«ã™ã‚‹
        drawingToolsContainer.style.display = 'none'; // æç”»ãƒ„ãƒ¼ãƒ«å…¨ä½“ã‚’éè¡¨ç¤º
      }

      function sendDrawingEvent(x, y, control) {
        const message = JSON.stringify({
          x, y, control, color: eraserMode ? "#ffffff" : colorPicker.value,
          width: lineWidthSlider.value,
          eraser: eraserMode,
          type: 'paint'
        })
        ws.send(message)
      }

      function setDrawingTurnUI() {
        isDrawingTurn = true;
        isAnsweringTurn = false;
        enableDrawingTools(); // æç”»ãƒ„ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–

        // â¬…ï¸ ã‚­ãƒ£ãƒ³ãƒã‚¹è¡¨ç¤ºå†é–‹
        canvas.style.display = 'block';
        receivedCanvas.style.display = 'block';

        // å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°æ¶ˆã™
        const msg = document.getElementById('waitingMessage');
        if (msg) msg.remove();

        chatForm.style.display = 'none';
        sendPictureButton.style.display = 'block'
        chatInput.placeholder = "çµµã‚’æã„ã¦ã€ŒSend Pictureã€ã‚’æŠ¼ã—ã¦ãã ã•ã„"

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        receivedCtx.clearRect(0, 0, receivedCanvas.width, receivedCanvas.height);

      }

      function setAnsweringTurnUI() {
        isDrawingTurn = false;
        isAnsweringTurn = true;
        disableDrawingTools(); // æç”»ãƒ„ãƒ¼ãƒ«ã‚’ç„¡åŠ¹åŒ–

        chatForm.style.display = 'flex';
        sendPictureButton.style.display = 'none';
        chatInput.placeholder = "ä½•ã‚’æã„ãŸã‹â€ã²ã‚‰ãŒãªã§â€å…¥åŠ›ã—ã¦ãã ã•ã„";
        chatInput.value = '';
        chatInput.focus();
      }

      function setChatModeUI() {
        isDrawingTurn = false;
        isAnsweringTurn = false;

        chatForm.style.display = 'flex';
        sendPictureButton.style.display = 'none';
        chatInput.placeholder = "ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›";
        chatInput.value = '';
        chatInput.focus();

        // åˆæœŸåŒ–æ™‚ã«ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
        ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        receivedCtx.clearRect(0, 0, receivedCanvas.width, receivedCanvas.height);
      }

      function showWaitingScreen(currentPlayer) {
        isDrawingTurn = false;
        isAnsweringTurn = false;
        disableDrawingTools();

        chatForm.style.display = 'none';
        sendPictureButton.style.display = 'none';

        // ğŸŸ¥ ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        canvas.style.display = 'none';
        receivedCanvas.style.display = 'none';

        // ğŸŸ© å¾…æ©Ÿç”¨ã®ä»£æ›¿è¡¨ç¤ºã‚’ canvas ã®ä»£ã‚ã‚Šã«è¡¨ç¤ºã™ã‚‹ï¼ˆå¿…è¦ã§ã‚ã‚Œã°ï¼‰
        const waitingMessage = document.createElement('div');
        waitingMessage.id = 'waitingMessage';
        waitingMessage.style.fontSize = '24px';
        waitingMessage.style.fontWeight = 'bold';
        waitingMessage.style.textAlign = 'center';
        waitingMessage.style.marginTop = '40px';
        waitingMessage.textContent = `ã€Œ${currentPlayer}ã€ãŒå›ç­”ä¸­ã§ã™...`;

        // ã™ã§ã«è¡¨ç¤ºã•ã‚Œã¦ã„ãŸã‚‰æ¶ˆã™
        const existing = document.getElementById('waitingMessage');
        if (existing) existing.remove();

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è¦ªè¦ç´ ã«è¿½åŠ 
        document.querySelector('.canvases-container').appendChild(waitingMessage);
      }


      ws.onopen = () => {
        // æ¥ç¶šæ™‚ã«joinãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹
        ws.send(JSON.stringify({ type: 'join', id: myId }));
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data)
        if (msg.type === 'paint') {
          const { x, y, control, color, width } = msg
          console.log({ control })
          if (color) ctx.strokeStyle = color;
          if (width) ctx.lineWidth = parseFloat(width);

          if (control === 'mousedown') {
            mousedown()
          } else if (control === 'mouseup') {
            mouseup()
          } else if (control === 'mousemove') {
            mousemove(x, y)
          } else if (control === 'mouseout') {
            mouseout()
          }
        }

        if (msg.type === 'image_sended') {
          const img = new Image();
          img.onload = function () {
            receivedCtx.clearRect(0, 0, receivedCanvas.width, receivedCanvas.height);
            receivedCtx.drawImage(img, 0, 0);
          };
          img.src = msg.imageData;
        }

        if (msg.type === 'players') {
          players = new Set(msg.players);
          updatePlayerCountDisplay();
          return;
        }

        if (msg.type === 'start') {
          // å…¨å“¡ãŒå—ã‘å–ã‚‹ã¨ã“ã“ãŒå‹•ãã®ã§ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
          chatArea.style.display = 'block';
          canvas.style.display = 'block';
          chatInput.style.display = 'block'

          document.getElementById('roundSelect').parentElement.style.display = 'none';
          document.getElementById('turnSelect').parentElement.style.display = 'none';
          document.getElementById('startButton').style.display = 'none';

          const firstCharEl = document.getElementById('firstChar');
          firstCharEl.textContent = 'æœ€åˆã®æ–‡å­—: ' + msg.firstChar;
          firstCharEl.style.display = 'inline';


          // æœ€åˆã®æ–‡å­—ã‚’ã“ã“ã§æ›´æ–°
          if (msg.firstChar) {
            console.log("æœ€åˆã®æ–‡å­—:", msg.firstChar);
            const firstCharEl = document.getElementById('firstChar');
            firstCharEl.textContent = 'æœ€åˆã®æ–‡å­—: ' + msg.firstChar;
            firstCharEl.style.display = 'inline';
          }

          // ã‚¿ãƒ¼ãƒ³é †ã‚’è¡¨ç¤ºã¾ãŸã¯ä¿æŒ
          if (msg.turnOrder) {
            console.log("ã‚¿ãƒ¼ãƒ³é †:", msg.turnOrder);
            const turnOrderDisplay = document.getElementById('turnOrderDisplay');
            turnOrderDisplay.innerHTML = 'ã‚¿ãƒ¼ãƒ³é †: ' + msg.turnOrder.map(playerId => {
              return playerId === msg.currentPlayer
                ? `<span style="color: red; font-weight: bold;">${playerId}</span>`
                : `<span>${playerId}</span>`;
            }).join(' â†’ ');
            turnOrderDisplay.style.display = 'inline';
            alert(`æœ€åˆã®æ–‡å­—: ${msg.firstChar}\nã‚¿ãƒ¼ãƒ³é †: ${msg.turnOrder.join(" â†’ ")}`);
          }
          gameStarted = true;
          setDrawingTurnUI();
        }

        if (msg.type === 'chat') {
          const { id, text } = msg
          appendMessage(msg.id, msg.text, myId);
        }

        if (msg.type === 'answer') {
          const { id, text } = msg;

          answers.push({ id, text });
          console.log("ä¿å­˜ã•ã‚ŒãŸå›ç­”:", answers); // ãƒ‡ãƒãƒƒã‚°ç”¨
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        if (msg.type === 'next_turn') {
          const currentPlayer = msg.currentPlayer;
          const turnOrder = msg.turnOrder;

          const turnOrderDisplay = document.getElementById('turnOrderDisplay');
          turnOrderDisplay.innerHTML = 'ã‚¿ãƒ¼ãƒ³é †: ' + turnOrder.map(playerId => {
            return playerId === currentPlayer
              ? `<span style="color: red; font-weight: bold;">${playerId}</span>`
              : `<span>${playerId}</span>`;
          }).join(' â†’ ');
          turnOrderDisplay.style.display = 'inline';
          if (currentPlayer === myId) {
            // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ï¼ˆå›ç­”ã™ã‚‹ï¼‰
            setAnsweringTurnUI();
          } else {
            // ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å¾…æ©Ÿç”»é¢
            showWaitingScreen(currentPlayer);
          }
        }



        if (msg.type === 'join') {
          players.add(msg.id); // å…¥å®¤ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚»ãƒƒãƒˆã«è¿½åŠ 
          updatePlayerCountDisplay();
          const messageList = document.querySelector('.messages');
          const li = document.createElement('li');
          li.textContent = msg.id + 'ãŒå…¥å®¤ã—ã¾ã—ãŸ '
          messageList.appendChild(li);
        }
      }

      function appendMessage(id, text, myId) {
        const messageList = document.querySelector('.messages');
        const li = document.createElement('li');
        if (id === myId) {
          li.className = 'my-message';
          li.textContent = id + ': ' + text
        } else {
          li.className = 'other-message';
          li.textContent = id + ': ' + text
        }
        messageList.appendChild(li);
      }

      const chatForm = document.querySelector('.form')



      chatForm.onsubmit = function (e) {
        e.preventDefault()
        const input = document.querySelector('.input')
        const text = input.value

        if (!gameStarted) {
          if (text !== '') { // ç©ºã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é€ä¿¡ã—ãªã„
            ws.send(JSON.stringify({ id: myId, text: text, type: 'chat' }));
          }
          input.value = ''
          input.focus()
          return;
        }

        if (isAnsweringTurn) {
          if (text !== '') {
            ws.send(JSON.stringify({ id: myId, text: text, type: 'answer' }));
            answers.push({ id: myId, text: text });
            input.value = ''
            input.focus()
          }
          //å›ç­”é€ä¿¡å¾Œæ¬¡ã®äººã®çµµã®ã‚¿ãƒ¼ãƒ³ã¸
          setDrawingTurnUI();
        }

      }

      sendPictureButton.onclick = () => {
        if (gameStarted && isDrawingTurn) {
          currentDrawingData = canvas.toDataURL('image/png');
          drawnImages.push(currentDrawingData);
          console.log("ä¿å­˜ã•ã‚ŒãŸç”»åƒ:" + drawnImages)

          // æã‹ã‚ŒãŸç”»åƒã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
          ws.send(JSON.stringify({ type: 'image_sended', imageData: currentDrawingData }));

          setAnsweringTurnUI();
        }
      }

      ws.onerror = function (error) {
        console.error('WebSocket Error: ', error)
      }
    }

    main()
  </script>
</body>

</html>