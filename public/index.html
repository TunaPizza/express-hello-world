<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Áµµ„Åó„Çä„Å®„Çä„Ç≤„Éº„É†Ë®≠ÂÆö</title>
  <style>
    .hidden { display: none; }
    .chat {
      display: flex;
      flex-direction: column;
      height: 80vh;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .form { display: flex; }
    .input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
    }
    .submit {
      padding: 10px;
      border: 1px solid #ccc;
      background: #eee;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Ë®≠ÂÆöÁîªÈù¢ -->
  <div id="setup">
    <h2>üéÆ Áµµ„Åó„Çä„Å®„Çä „Ç≤„Éº„É†Ë®≠ÂÆö</h2>
    <label>„É¶„Éº„Ç∂„ÉºÂêç: <input id="username" /></label><br />
    <label>„Çø„Éº„É≥Êï∞: 
      <button onclick="change('turns', -1)">‚àí</button>
      <span id="turns">3</span>
      <button onclick="change('turns', 1)">Ôºã</button>
    </label><br />
    <label>„É©„Ç¶„É≥„ÉâÊï∞: 
      <button onclick="change('rounds', -1)">‚àí</button>
      <span id="rounds">2</span>
      <button onclick="change('rounds', 1)">Ôºã</button>
    </label><br /><br />
    <button id="btnStartGame">„Ç≤„Éº„É†ÈñãÂßã</button>
  </div>

  <!-- „É°„Ç§„É≥ÁîªÈù¢ -->
  <div id="mainUI" class="hidden">
    <div class="chat">
      <ul class="messages"></ul>
      <form class="form">
        <input class="input" autocomplete="off" />
        <button class="submit">Send</button>
      </form>
    </div>
    <canvas id="canvas" width="600" height="600" style="border: solid 1px black"></canvas>
  </div>

<script>
  let myId = "", turns = 3, rounds = 2;
  let ws;

  function change(type, delta) {
    if (type === 'turns') {
      turns = Math.max(1, turns + delta);
      document.getElementById('turns').textContent = turns;
    } else if (type === 'rounds') {
      rounds = Math.max(1, rounds + delta);
      document.getElementById('rounds').textContent = rounds;
    }
  }

  document.getElementById('btnStartGame').onclick = () => {
    myId = document.getElementById('username').value.trim();
    if (!myId) {
      alert("„É¶„Éº„Ç∂„ÉºÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
      return;
    }

    // WebSocketÊé•Á∂ö
    const host = location.origin.replace(/^http/, 'ws');
    ws = new WebSocket(host + '/ws');

    ws.onopen = () => {
      // join„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
      ws.send(JSON.stringify({ type: 'join', id: myId, turns, rounds }));
    };

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === 'start') {
        // Ë®≠ÂÆöÁîªÈù¢„ÇíÈö†„Åó„Å¶„É°„Ç§„É≥ÁîªÈù¢„ÇíË°®Á§∫
        document.getElementById('setup').classList.add('hidden');
        document.getElementById('mainUI').classList.remove('hidden');
      }

      if (msg.type === 'chat') {
        const li = document.createElement('li');
        li.textContent = (msg.id === myId ? '(Ëá™ÂàÜ) ' : msg.id + ': ') + msg.text;
        document.querySelector('.messages').appendChild(li);
      }

      if (msg.type === 'paint') {
        const { x, y, control } = msg;
        if (control === 'mousedown') mousedown();
        else if (control === 'mouseup') mouseup();
        else if (control === 'mousemove') mousemove(x, y);
        else if (control === 'mouseout') mouseout();
      }
    };

    ws.onerror = (e) => console.error('WebSocket error:', e);

    // „ÉÅ„É£„ÉÉ„ÉàÈÄÅ‰ø°
    document.querySelector('.form').onsubmit = function (e) {
      e.preventDefault();
      const input = document.querySelector('.input');
      const text = input.value;
      ws.send(JSON.stringify({ id: myId, text, type: 'chat' }));
      input.value = '';
      input.focus();
    };

    // ÊèèÁîªÂá¶ÁêÜ
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    canvas.addEventListener('mousedown', (e) => sendDrawing(e.offsetX, e.offsetY, 'mousedown'));
    function mousedown() { drawing = true; ctx.beginPath(); }

    canvas.addEventListener('mousemove', (e) => {
      if (drawing) sendDrawing(e.offsetX, e.offsetY, 'mousemove');
    });
    function mousemove(x, y) { 
      if (drawing) { 
        ctx.lineTo(x, y); 
        ctx.stroke(); 
      } else { 
        ctx.moveTo(x, y); 
      } 
    }

    canvas.addEventListener('mouseup', () => sendDrawing(0, 0, 'mouseup'));
    function mouseup() { drawing = false; ctx.beginPath(); }

    canvas.addEventListener('mouseout', () => sendDrawing(0, 0, 'mouseout'));
    function mouseout() { drawing = false; }

    function sendDrawing(x, y, control) {
      ws.send(JSON.stringify({ x, y, control, type: 'paint' }));
    }
  };
</script>
</body>
</html>
